import { Component, OnInit } from '@angular/core';
import * as L from 'leaflet';
import { Platform } from '@ionic/angular';
import { trigger, style, animate, transition } from '@angular/animations';
import { RouteModel } from 'src/app/models/route.model';
import { SharedService } from 'src/app/services/shared/shared.service';
import { Router } from '@angular/router';
import { LineString, MultiLineString } from 'geojson';

@Component({
  selector: 'app-display-route',
  templateUrl: './display-route.page.html',
  styleUrls: ['./display-route.page.scss'],
  animations: [
    trigger('openClose', [
      transition(':enter', [
        style({ transform: 'translateX(-100%)' }),
        animate('250ms ease-in', style({ transform: 'translateX(0%)' }))
      ]),
      transition(':leave', [
        animate('250ms ease-in', style({ transform: 'translateX(-100%)' }))
      ])
    ])
  ]
})
export class DisplayRoutePage implements OnInit {

  // Get if running on Desktop or mobile
  showSideMenu: boolean;
  // Map
  map: L.Map;
  // Close side menu when user click button
  isOpen: boolean;
  // Route to view in the map
  route: RouteModel
  // Segment highlighted & zoomed when instruction is selected
  stepSelected: L.Polyline;
  // Steps/instructions of walk & bike 
  segmentsSteps: Map<number, any>;
  // Store if it's a subway/bus/commuter or walk/bike segment, the icon to display & if line is solid or dotted
  segmentsVisual: any[];

  constructor(
    private platform: Platform,
    private sharedService: SharedService,
    private router: Router
  ) { }

  ngOnInit() {
    this.platform.ready().then(() => {
      this.showSideMenu = this.platform.is('desktop');
    });

    // Different icon for the mode of transport
    let iconTransport: Map<string, string> = new Map<string, string>([['A pie', 'walk.png'], ['Metro', 'subway.png'],
    ['Bus', 'bus.png'], ['BiciMAD', 'bicycle.png'], ['Cercanías', 'commuter.png']]);
    // Map with line zones associated to general line
    let linesZone: Map<string, string> = new Map<string, string>([["6-1", "6"], ["6-2", "6"], ["7a", "7"], ["7b", "7"],
    ["9A", "9"], ["9B", "9"], ["10a", "10"], ["10b","10"], ["12-1", "12"], ["12-2", "12"]]);
    // Init segmentsSteps
    this.segmentsSteps = new Map<number, string>();
    // Init segmentsVisual
    this.segmentsVisual = [];

    this.route = this.sharedService.getRoute();
    this.sharedService.setRoute(undefined);
    if (!this.route) {

      this.route = {
        id: 13341, 
        name: "ruta1", 
        origin: { id: 13343, name: "2, Plaza de Ortega y Gasset, Coslada, Área metropolitana de Madrid y Corredor del Henares, Comunidad de Madrid, 28821, España", longitude: -3.5655006, latitude: 40.4241342 }, 
        destination: { id: 13342, name: "Sol, Puerta del Sol, Barrio de los Austrias, Sol, Centro, Madrid, Área metropolitana de Madrid y Corredor del Henares, Comunidad de Madrid, 28013, España", longitude: -3.7033901, latitude: 40.416938 }, 
        maxDistance: 0.8, 
        transports: [ "Metro", "Bus", "Cercanías", "BiciMAD" ], "preferences": { "C_Instalaciones culturales": 4, "C_Parques y jardines": 5, "C_Escuelas de cocina y catas de vinos y aceites": 1, "C_Empresas de guías Turísticas": 0, "C_Edificios y monumentos": 3, "C_Centros de ocio": 0, "D_Deportes": 1, "T_Tiendas": 2, "R_Restauración": 2 }, 
        date: new Date("2022-04-02"), 
        distance: 21.870000000000005, 
        duration: 249, 
        points: [ 
          { id: 13343, name: "2, Plaza de Ortega y Gasset, Coslada, Área metropolitana de Madrid y Corredor del Henares, Comunidad de Madrid, 28821, España", longitude: -3.5655006, latitude: 40.4241342 }, 
          { id: 4116, name: "Barrio del Puerto", longitude: -3.56918847026566, latitude: 40.422496870095998 }, 
          { id: 3622, name: "Estadio Metropolitano", longitude: -3.60015365421252, latitude: 40.4333934840999 }, 
          { id: 4433, name: "Carretera San Blas a Coslada frente Metr", longitude: -3.60185, latitude: 40.43314 }, 
          { id: 8638, name: "Samaniego-Campezo", longitude: -3.58225281978725, latitude: 40.4442182800406 }, 
          { id: 6473, name: "Deyanira-Pirra", longitude: -3.58889699220807, latitude: 40.443378383897 }, 
          { id: 6417, name: "Deyanira-Euterpe", longitude: -3.59218878743713, latitude: 40.4436724131954 }, 
          { id: 8703, name: "Avenida Segunda-Calle Ocho", longitude: -3.59415003667188, latitude: 40.4469957098769 }, 
          { id: 8090, name: "Avenida Tercera-Calle Tres", longitude: -3.5946109801984, latitude: 40.449250104787 }, 
          { id: 8089, name: "Alcalá-Avenida Séptima", longitude: -3.60022807474974, latitude: 40.4499914035597 }, 
          { id: 8696, name: "Canillejas", longitude: -3.60960755544828, latitude: 40.448591063694 }, 
          { id: 8111, name: "Alcalá-Esfinge", longitude: -3.61241471254279, latitude: 40.4467699461975 }, 
          { id: 7923, name: "Alcalá-Avenida Canillejas", longitude: -3.61664901360015, latitude: 40.4440672954322 }, 
          { id: 6667, name: "Alcalá-25 de Septiembre", longitude: -3.62287003107297, latitude: 40.4422231924708 }, 
          { id: 7909, name: "Suanzes", longitude: -3.62783351917846, latitude: 40.4408630567618 }, 
          { id: 7913, name: "Alcalá-Alfonso Gómez", longitude: -3.6308389012212, latitude: 40.4400359135584 }, 
          { id: 8694, name: "Alcalá-Santa Leonor", longitude: -3.63294040822713, latitude: 40.4394523746604 }, 
          { id: 4656, name: "Ciudad Lineal", longitude: -3.63868345198661, latitude: 40.4382001229349 }, 
          { id: 3570, name: "Alcalá-Arcones Gil", longitude: -3.64066076857845, latitude: 40.4369279379069 }, 
          { id: 3587, name: "Pueblo Nuevo", longitude: -3.6438178363031, latitude: 40.4353879047579 }, 
          { id: 3595, name: "Quintana", longitude: -3.64797334027745, latitude: 40.43347283304 }, 
          { id: 3527, name: "Alcalá-Mateo García", longitude: -3.65290551691689, latitude: 40.4326523376265 }, 
          { id: 7615, name: "El Carmen", longitude: -3.65719143707254, latitude: 40.4320695357297 }, 
          { id: 7611, name: "Ventas", longitude: -3.66318318129544, latitude: 40.4311164578004 }, 
          { id: 3604, name: "Manuel Becerra", longitude: -3.66925820304973, latitude: 40.427904173807399 }, 
          { id: 4118, name: "Goya", longitude: -3.67684614290745, latitude: 40.424805404818002 }, 
          { id: 3628, name: "Velázquez", longitude: -3.6829181480862, latitude: 40.4250325508648 }, 
          { id: 4002, name: "Serrano", longitude: -3.68663043638334, latitude: 40.425432159419 }, 
          { id: 3792, name: "Colón", longitude: -3.69100739257143, latitude: 40.4254191821374 }, 
          { id: 3680, name: "Alonso Martínez", longitude: -3.69593869523326, latitude: 40.427720113338701 }, 
          { id: 3789, name: "Tribunal", longitude: -3.70109984950459, latitude: 40.4261853955902 }, 
          { id: 3664, name: "Gran Vía", longitude: -3.70180393013566, latitude: 40.4199866177357 }, 
          { id: 13342, name: "Sol, Puerta del Sol, Barrio de los Austrias, Sol, Centro, Madrid, Área metropolitana de Madrid y Corredor del Henares, Comunidad de Madrid, 28013, España", longitude: -3.7033901, latitude: 40.416938 } ], 
        segments: [ 
          { id: 13344, source: 0, target: 1, distance: 0.51, duration: 6, transportMode: "A pie", steps: [ "0-1:Camina hacia el noroeste en Plaza de Ortega y Gasset", "1-7:¡Gire a la izquierda a Calle Doctor Barraquer!", "7-11:¡Gire a la derecha a Calle Doctor Fleming!", "11-12:¡Gire a la izquierda a Calle Jaén!", "12-14:¡Gire a la derecha!", "14-15:¡Gire a la izquierda!", "15-18:¡Gire ligeramente a la derecha!", "18-22:¡Gire a la izquierda!", "22-23:¡Gire a la derecha!", "23-24:¡Gire a la izquierda!", "24-24:Llegar a su destino, a la derecha" ], "polyline": [ [ 40.424189, -3.565483 ], [ 40.424356, -3.565705 ], [ 40.424331, -3.565741 ], [ 40.424161, -3.565968 ], [ 40.424143, -3.565984 ], [ 40.424127, -3.565989 ], [ 40.423911, -3.565952 ], [ 40.423834, -3.565939 ], [ 40.423773, -3.566742 ], [ 40.423755, -3.566993 ], [ 40.42375, -3.567113 ], [ 40.423681, -3.567938 ], [ 40.423602, -3.567933 ], [ 40.423592, -3.568054 ], [ 40.423587, -3.56814 ], [ 40.422728, -3.568038 ], [ 40.422688, -3.568057 ], [ 40.422667, -3.568067 ], [ 40.422698, -3.568203 ], [ 40.422627, -3.568244 ], [ 40.422569, -3.568273 ], [ 40.422526, -3.568294 ], [ 40.422491, -3.568312 ], [ 40.422651, -3.568941 ], [ 40.422456, -3.569024 ] ], line: null, destination: null, color: "#2D2E2D" }, 
          { id: 13345, source: 1, target: 2, distance: 2.96, duration: 13, transportMode: "Metro", steps: [], "polyline": [ [ 40.4226119848456, -3.5688490093316 ], [ 40.4228257467912, -3.56964986528915 ], [ 40.4232648570085, -3.5712540810367 ], [ 40.4235865040925, -3.57239417931484 ], [ 40.4292890343272, -3.59550784938839 ], [ 40.4323929426621, -3.59904982451004 ], [ 40.4331690544744, -3.60007448596855 ], [ 40.4332019756963, -3.60012301215212 ] ], line: "7b", destination: "Estadio Metropolitano", color: "#EE7518" }, 
          { id: 13346, source: 2, target: 3, distance: 0.21, duration: 3, transportMode: "A pie", steps: [ "0-5:Camina hacia el oeste", "5-7:¡Gire a la izquierda!", "7-8:¡Gire a la izquierda!", "8-11:¡Gire a la derecha!", "11-17:¡Gire a la izquierda!", "17-21:¡Gire a la derecha!", "21-21:Llegar a su destino, a la derecha" ], "polyline": [ [ 40.433387, -3.600152 ], [ 40.433382, -3.60019 ], [ 40.433394, -3.600283 ], [ 40.433421, -3.600361 ], [ 40.433456, -3.600391 ], [ 40.433574, -3.600433 ], [ 40.433566, -3.600497 ], [ 40.433535, -3.60073 ], [ 40.433438, -3.60071 ], [ 40.433431, -3.600771 ], [ 40.433398, -3.601038 ], [ 40.4334, -3.601188 ], [ 40.433331, -3.601203 ], [ 40.433254, -3.601249 ], [ 40.433178, -3.601295 ], [ 40.433067, -3.601362 ], [ 40.43304, -3.601378 ], [ 40.432982, -3.601412 ], [ 40.432989, -3.601435 ], [ 40.433019, -3.601534 ], [ 40.433058, -3.601664 ], [ 40.433128, -3.601858 ] ], line: null, destination: null, color: "#2D2E2D" }, 
          { id: 13347, source: 3, target: 4, distance: 4.58, duration: 23, transportMode: "Bus", steps: [], "polyline": [ [ 40.43319, -3.601821 ], [ 40.433119, -3.601606 ], [ 40.433049, -3.601401 ], [ 40.43304, -3.601378 ], [ 40.432912, -3.600958 ], [ 40.432869, -3.600835 ], [ 40.432809, -3.600802 ], [ 40.432716, -3.600685 ], [ 40.432676, -3.600524 ], [ 40.432679, -3.600439 ], [ 40.432694, -3.600371 ], [ 40.432718, -3.600308 ], [ 40.432751, -3.600252 ], [ 40.43266, -3.600115 ], [ 40.432469, -3.599901 ], [ 40.432054, -3.599486 ], [ 40.431568, -3.599124 ], [ 40.43129, -3.598918 ], [ 40.431135, -3.598789 ], [ 40.431004, -3.598666 ], [ 40.430777, -3.598419 ], [ 40.430672, -3.598254 ], [ 40.430272, -3.597633 ], [ 40.430182, -3.597531 ], [ 40.430098, -3.597481 ], [ 40.430012, -3.597481 ], [ 40.429919, -3.597449 ], [ 40.429796, -3.597366 ], [ 40.429679, -3.597239 ], [ 40.429634, -3.597161 ], [ 40.429569, -3.596932 ], [ 40.429563, -3.596822 ], [ 40.429586, -3.596672 ], [ 40.429628, -3.596513 ], [ 40.429677, -3.596369 ], [ 40.429702, -3.596328 ], [ 40.429711, -3.596218 ], [ 40.429703, -3.595983 ], [ 40.42967, -3.595815 ], [ 40.42944, -3.595062 ], [ 40.429163, -3.59407 ], [ 40.428763, -3.59263 ], [ 40.427162, -3.587045 ], [ 40.426876, -3.585875 ], [ 40.426784, -3.585315 ], [ 40.426736, -3.584759 ], [ 40.42675, -3.583772 ], [ 40.426923, -3.5823 ], [ 40.42698, -3.581709 ], [ 40.426999, -3.581263 ], [ 40.426981, -3.580535 ], [ 40.426926, -3.58009 ], [ 40.426853, -3.579698 ], [ 40.426833, -3.579632 ], [ 40.426738, -3.579553 ], [ 40.426675, -3.579431 ], [ 40.426655, -3.579287 ], [ 40.42668, -3.579143 ], [ 40.426746, -3.579025 ], [ 40.426831, -3.578956 ], [ 40.42693, -3.578932 ], [ 40.427028, -3.578956 ], [ 40.427111, -3.579022 ], [ 40.427172, -3.579122 ], [ 40.427316, -3.57918 ], [ 40.427477, -3.579175 ], [ 40.427753, -3.579119 ], [ 40.427916, -3.579059 ], [ 40.428294, -3.578875 ], [ 40.428415, -3.578765 ], [ 40.428515, -3.578639 ], [ 40.428658, -3.57837 ], [ 40.428708, -3.578219 ], [ 40.428745, -3.578057 ], [ 40.428752, -3.577694 ], [ 40.428736, -3.577524 ], [ 40.428617, -3.577221 ], [ 40.42857, -3.577014 ], [ 40.428567, -3.576913 ], [ 40.42857, -3.576865 ], [ 40.428603, -3.576823 ], [ 40.428653, -3.576768 ], [ 40.428889, -3.576728 ], [ 40.429287, -3.576724 ], [ 40.429672, -3.576786 ], [ 40.42995, -3.576876 ], [ 40.430126, -3.576982 ], [ 40.430342, -3.577096 ], [ 40.430689, -3.577334 ], [ 40.430748, -3.577375 ], [ 40.431277, -3.577749 ], [ 40.43144, -3.577864 ], [ 40.432166, -3.578371 ], [ 40.432854, -3.578852 ], [ 40.433367, -3.579225 ], [ 40.434824, -3.580261 ], [ 40.435189, -3.580558 ], [ 40.435555, -3.580877 ], [ 40.436229, -3.581608 ], [ 40.436545, -3.581897 ], [ 40.436848, -3.582124 ], [ 40.437073, -3.58225 ], [ 40.438149, -3.582718 ], [ 40.438482, -3.582892 ], [ 40.439265, -3.583391 ], [ 40.439407, -3.583463 ], [ 40.439617, -3.583547 ], [ 40.4398, -3.583587 ], [ 40.439951, -3.583613 ], [ 40.440231, -3.583599 ], [ 40.440629, -3.583538 ], [ 40.441063, -3.583466 ], [ 40.44198, -3.583335 ], [ 40.442538, -3.583246 ], [ 40.442646, -3.583228 ], [ 40.443917, -3.583009 ], [ 40.444031, -3.58299 ], [ 40.444083, -3.582981 ], [ 40.444385, -3.582926 ], [ 40.444501, -3.582909 ], [ 40.444506, -3.582843 ], [ 40.444524, -3.582804 ], [ 40.444549, -3.582779 ], [ 40.4445, -3.582681 ], [ 40.444296, -3.582381 ], [ 40.444216, -3.582268 ], [ 40.444211, -3.582261 ] ], line: "167", destination: "Fin de Semana", color: "#0178BC" }, 
          { id: 13348, source: 4, target: 5, distance: 0.79, duration: 10, transportMode: "A pie", steps: [ "0-4:Camina hacia el noroeste en Calle de Samaniego", "4-10:¡Entre en la rotonda y tome la 1a salida a Calle de Campezo!", "10-13:¡Gire a la derecha a Calle de Pirra!", "13-14:¡Gire ligeramente a la derecha a Calle de Pirra!", "14-20:¡Gire a la izquierda!", "20-23:¡Gire a la izquierda!", "23-23:Llegar a su destino, a la derecha" ], "polyline": [ [ 40.444211, -3.582261 ], [ 40.444216, -3.582268 ], [ 40.444296, -3.582381 ], [ 40.4445, -3.582681 ], [ 40.444549, -3.582779 ], [ 40.444524, -3.582804 ], [ 40.444506, -3.582843 ], [ 40.444501, -3.582909 ], [ 40.444385, -3.582926 ], [ 40.444083, -3.582981 ], [ 40.444031, -3.58299 ], [ 40.444019, -3.583084 ], [ 40.444197, -3.584937 ], [ 40.444324, -3.586186 ], [ 40.44444, -3.586313 ], [ 40.444407, -3.586353 ], [ 40.444758, -3.586852 ], [ 40.444881, -3.587074 ], [ 40.445088, -3.587537 ], [ 40.445152, -3.587713 ], [ 40.445183, -3.587899 ], [ 40.444202, -3.588381 ], [ 40.443947, -3.588509 ], [ 40.443353, -3.588809 ] ], line: null, destination: null, color: "#2D2E2D" }, 
          { id: 13349, source: 5, target: 6, distance: 0.28, duration: 13, transportMode: "Bus", steps: [], "polyline": [ [ 40.443203, -3.588927 ], [ 40.443316, -3.590068 ], [ 40.443337, -3.590316 ], [ 40.443354, -3.590508 ], [ 40.443402, -3.591066 ], [ 40.443483, -3.591681 ], [ 40.443501, -3.591831 ], [ 40.443531, -3.592208 ] ], line: "77", destination: "Ciudad Lineal", color: "#0178BC" }, 
          { id: 13350, source: 6, target: 7, distance: 0.55, duration: 7, transportMode: "A pie", steps: [ "0-2:Camina hacia el norte", "2-6:¡Gire a la izquierda!", "6-7:¡Gire a la izquierda!", "7-12:¡Gire a la derecha a Calle de Euterpe!", "12-14:¡Gire a la izquierda a Calle de Pasifae!", "14-16:¡Gire a la derecha a Carretera de acceso a la Estación de O'Donnell!", "16-18:¡Gire a la izquierda!", "18-22:¡Gire a la derecha a Avenida Segunda!", "22-22:Llegar a Avenida Segunda, a la derecha" ], "polyline": [ [ 40.443678, -3.592206 ], [ 40.443795, -3.592144 ], [ 40.44385, -3.592114 ], [ 40.443858, -3.592144 ], [ 40.443891, -3.592197 ], [ 40.443948, -3.592235 ], [ 40.443982, -3.592239 ], [ 40.443984, -3.592431 ], [ 40.444288, -3.592463 ], [ 40.444392, -3.592459 ], [ 40.444462, -3.592453 ], [ 40.445171, -3.592422 ], [ 40.445248, -3.592419 ], [ 40.44525, -3.592556 ], [ 40.445268, -3.593454 ], [ 40.446124, -3.593419 ], [ 40.446232, -3.593414 ], [ 40.446241, -3.593667 ], [ 40.446263, -3.594292 ], [ 40.44648, -3.594276 ], [ 40.446905, -3.594236 ], [ 40.446939, -3.594234 ], [ 40.447, -3.594228 ] ], line: null, destination: null, color: "#2D2E2D" }, {
          id: 13351, source: 7, target: 8, distance: 0.3, duration: 13, transportMode: "Bus", steps: [], "polyline": [ [ 40.447, -3.594228 ], [ 40.447049, -3.594223 ], [ 40.447627, -3.59417 ], [ 40.448265, -3.594108 ], [ 40.448303, -3.594706 ], [ 40.448635, -3.594676 ], [ 40.448862, -3.594655 ], [ 40.449009, -3.594644 ], [ 40.449095, -3.594641 ], [ 40.449184, -3.594635 ], [ 40.449251, -3.594629 ] ], line: "77", destination: "Ciudad Lineal", color: "#0178BC" }, 
          { id: 13352, source: 8, target: 9, distance: 0.55, duration: 7, transportMode: "A pie", steps: [ "0-5:Camina hacia el norte en Avenida Tercera", "5-13:¡Gire bastante a la izquierda a Calle de Alcalá!", "13-13:Llegar a Calle de Alcalá, a la derecha" ], "polyline": [ [ 40.449251, -3.594629 ], [ 40.449334, -3.594622 ], [ 40.449661, -3.594576 ], [ 40.449767, -3.594568 ], [ 40.449807, -3.594542 ], [ 40.449851, -3.594513 ], [ 40.449865, -3.595244 ], [ 40.449884, -3.596098 ], [ 40.449884, -3.596118 ], [ 40.449895, -3.596607 ], [ 40.449899, -3.597763 ], [ 40.449895, -3.599086 ], [ 40.449893, -3.600219 ], [ 40.449893, -3.600227 ] ], line: null, destination: null, color: "#2D2E2D" }, 
          { id: 13353, source: 9, target: 11, distance: 1.32, duration: 16, transportMode: "Bus", steps: [], "polyline": [ [ 40.449893, -3.600227 ], [ 40.449892, -3.600342 ], [ 40.449887, -3.600549 ], [ 40.449798, -3.601771 ], [ 40.449793, -3.601831 ], [ 40.449745, -3.602538 ], [ 40.449717, -3.602881 ], [ 40.449651, -3.603485 ], [ 40.449589, -3.604136 ], [ 40.449551, -3.604959 ], [ 40.449542, -3.605264 ], [ 40.449521, -3.606149 ], [ 40.449504, -3.607174 ], [ 40.449483, -3.607644 ], [ 40.449428, -3.608151 ], [ 40.449444, -3.608232 ], [ 40.449476, -3.608286 ], [ 40.449526, -3.608315 ], [ 40.449541, -3.608308 ], [ 40.449597, -3.60829 ], [ 40.449727, -3.608287 ], [ 40.449792, -3.608301 ], [ 40.449811, -3.60831 ], [ 40.449904, -3.608374 ], [ 40.449979, -3.608469 ], [ 40.450031, -3.608583 ], [ 40.450062, -3.608741 ], [ 40.450053, -3.608904 ], [ 40.450025, -3.609007 ], [ 40.449981, -3.609101 ], [ 40.449903, -3.609199 ], [ 40.449807, -3.609265 ], [ 40.449783, -3.609275 ], [ 40.449703, -3.609298 ], [ 40.449613, -3.609293 ], [ 40.449531, -3.609267 ], [ 40.449455, -3.609215 ], [ 40.449395, -3.60916 ], [ 40.449348, -3.609076 ], [ 40.449313, -3.608975 ], [ 40.449215, -3.608948 ], [ 40.449046, -3.608919 ], [ 40.448933, -3.608974 ], [ 40.448824, -3.609052 ], [ 40.448589, -3.60926 ], [ 40.448561, -3.609294 ], [ 40.448456, -3.609459 ], [ 40.448362, -3.609606 ], [ 40.448302, -3.609698 ], [ 40.44783, -3.610421 ], [ 40.447763, -3.610529 ], [ 40.447149, -3.611468 ], [ 40.447085, -3.611573 ], [ 40.447023, -3.611669 ], [ 40.446866, -3.611925 ], [ 40.446643, -3.612275 ] ], line: "77", destination: "Ciudad Lineal", color: "#0178BC" }, 
          { id: 13354, source: 11, target: 12, distance: 0.48, duration: 6, transportMode: "A pie", steps: [ "0-4:Camina hacia el suroeste", "4-6:¡Gire a la izquierda!", "6-24:¡Gire a la izquierda!", "24-24:Llegar a su destino, a la derecha" ], "polyline": [ [ 40.44671, -3.612345 ], [ 40.446653, -3.612431 ], [ 40.446627, -3.612474 ], [ 40.446626, -3.612516 ], [ 40.44665, -3.61255 ], [ 40.446614, -3.612609 ], [ 40.446588, -3.612654 ], [ 40.446547, -3.612618 ], [ 40.446518, -3.612629 ], [ 40.446127, -3.613236 ], [ 40.446095, -3.613304 ], [ 40.446071, -3.613338 ], [ 40.445445, -3.614286 ], [ 40.445418, -3.614336 ], [ 40.445414, -3.614388 ], [ 40.445129, -3.61483 ], [ 40.445132, -3.614863 ], [ 40.445114, -3.614907 ], [ 40.445093, -3.614939 ], [ 40.445055, -3.61493 ], [ 40.444531, -3.615732 ], [ 40.44423, -3.61622 ], [ 40.444202, -3.61625 ], [ 40.444181, -3.616272 ], [ 40.444007, -3.616592 ] ], line: null, destination: null, color: "#2D2E2D" }, 
          { id: 13355, source: 12, target: 13, distance: 0.57, duration: 25, transportMode: "Bus", steps: [], "polyline": [ [ 40.443918, -3.616498 ], [ 40.443876, -3.616569 ], [ 40.443725, -3.616867 ], [ 40.443693, -3.61695 ], [ 40.443603, -3.617171 ], [ 40.443427, -3.617666 ], [ 40.443283, -3.618174 ], [ 40.442939, -3.619384 ], [ 40.442717, -3.620198 ], [ 40.442698, -3.620267 ], [ 40.44266, -3.620416 ], [ 40.442025, -3.622778 ] ], line: "105", destination: "Ciudad Lineal", color: "#0178BC" }, 
          { id: 13356, source: 13, target: 14, distance: 0.45, duration: 5, transportMode: "A pie", steps: [ "0-3:Camina hacia el oeste", "3-16:¡Gire ligeramente a la izquierda!", "16-20:¡Gire a la derecha!", "20-20:Llegar a su destino, a la derecha" ], "polyline": [ [ 40.442127, -3.622825 ], [ 40.442081, -3.622993 ], [ 40.441995, -3.6233 ], [ 40.441998, -3.623316 ], [ 40.441995, -3.623327 ], [ 40.441987, -3.623354 ], [ 40.441962, -3.623443 ], [ 40.441901, -3.623663 ], [ 40.441883, -3.623729 ], [ 40.441864, -3.623796 ], [ 40.441849, -3.623852 ], [ 40.441828, -3.62392 ], [ 40.441799, -3.624018 ], [ 40.441373, -3.625586 ], [ 40.441175, -3.626302 ], [ 40.441055, -3.626711 ], [ 40.441015, -3.626822 ], [ 40.441032, -3.626831 ], [ 40.440958, -3.627108 ], [ 40.440899, -3.627328 ], [ 40.440773, -3.627791 ] ], line: null, destination: null, color: "#2D2E2D" }, 
          { id: 13357, source: 14, target: 16, distance: 0.49, duration: 13, transportMode: "Bus", steps: [], "polyline": [ [ 40.440706, -3.62776 ], [ 40.440694, -3.627803 ], [ 40.440643, -3.627984 ], [ 40.4406, -3.62814 ], [ 40.440332, -3.629118 ], [ 40.440227, -3.629502 ], [ 40.440212, -3.629557 ], [ 40.440153, -3.629796 ], [ 40.440072, -3.630129 ], [ 40.440023, -3.630305 ], [ 40.43999, -3.630432 ], [ 40.439927, -3.630656 ], [ 40.440007, -3.630689 ], [ 40.440062, -3.630709 ], [ 40.440007, -3.630689 ], [ 40.439927, -3.630656 ], [ 40.439797, -3.631133 ], [ 40.439731, -3.631382 ], [ 40.439626, -3.631779 ], [ 40.439586, -3.631929 ], [ 40.439516, -3.632185 ], [ 40.439486, -3.632292 ], [ 40.439471, -3.632348 ], [ 40.439329, -3.632884 ] ], line: "77", destination: "Ciudad Lineal", color: "#0178BC" }, 
          { id: 13358, source: 16, target: 17, distance: 0.56, duration: 7, transportMode: "A pie", steps: [ "0-2:Camina hacia el oeste en Calle de Alcalá", "2-3:¡Gire a la derecha a Calle de Riobamba!", "3-11:¡Gire a la izquierda!", "11-12:¡Gire a la izquierda a Calle del General Aranaz!", "12-25:¡Gire a la derecha a Calle de Alcalá!", "25-28:¡Gire a la derecha a Calle de Arturo Soria!", "28-29:¡Gire a la izquierda!", "29-31:¡Gire a la derecha!", "31-33:¡Gire a la derecha!", "33-35:¡Gire ligeramente a la izquierda!", "35-35:Llegar a su destino, a la derecha" ], "polyline": [ [ 40.439329, -3.632884 ], [ 40.439319, -3.63292 ], [ 40.439226, -3.633237 ], [ 40.439292, -3.633266 ], [ 40.439279, -3.633316 ], [ 40.43908, -3.63402 ], [ 40.439069, -3.634076 ], [ 40.438978, -3.634407 ], [ 40.438813, -3.635003 ], [ 40.438693, -3.63544 ], [ 40.438727, -3.635467 ], [ 40.438697, -3.635559 ], [ 40.438608, -3.635495 ], [ 40.43859, -3.635563 ], [ 40.438466, -3.635998 ], [ 40.438412, -3.636078 ], [ 40.438239, -3.636726 ], [ 40.438165, -3.637006 ], [ 40.438094, -3.637274 ], [ 40.438051, -3.637435 ], [ 40.43797, -3.637737 ], [ 40.437924, -3.637912 ], [ 40.437905, -3.637974 ], [ 40.437888, -3.638033 ], [ 40.437866, -3.638097 ], [ 40.437834, -3.638186 ], [ 40.437917, -3.638238 ], [ 40.438031, -3.638313 ], [ 40.43808, -3.638349 ], [ 40.438065, -3.63843 ], [ 40.438091, -3.638461 ], [ 40.438103, -3.638514 ], [ 40.438137, -3.638555 ], [ 40.438156, -3.638602 ], [ 40.438154, -3.638659 ], [ 40.438154, -3.638663 ] ], line: null, destination: null, color: "#2D2E2D" }, 
          { id: 13359, source: 17, target: 20, distance: 1.02, duration: 20, transportMode: "Bus", steps: [], "polyline": [ [ 40.43828, -3.638494 ], [ 40.438178, -3.63842 ], [ 40.43808, -3.638349 ], [ 40.438031, -3.638313 ], [ 40.437917, -3.638238 ], [ 40.437834, -3.638186 ], [ 40.437774, -3.638354 ], [ 40.437728, -3.638482 ], [ 40.437685, -3.638602 ], [ 40.437664, -3.638655 ], [ 40.437648, -3.638693 ], [ 40.437576, -3.638856 ], [ 40.437513, -3.638991 ], [ 40.437489, -3.639042 ], [ 40.437453, -3.639117 ], [ 40.437292, -3.639463 ], [ 40.437192, -3.639665 ], [ 40.437098, -3.639857 ], [ 40.43706, -3.639935 ], [ 40.436977, -3.640107 ], [ 40.436914, -3.640237 ], [ 40.436869, -3.640331 ], [ 40.436772, -3.640531 ], [ 40.43643, -3.641239 ], [ 40.436379, -3.641345 ], [ 40.436292, -3.641536 ], [ 40.436258, -3.641606 ], [ 40.436231, -3.64166 ], [ 40.436177, -3.641773 ], [ 40.435989, -3.64216 ], [ 40.435873, -3.642398 ], [ 40.435678, -3.642791 ], [ 40.435399, -3.643376 ], [ 40.435258, -3.643669 ], [ 40.435245, -3.643697 ], [ 40.435193, -3.643804 ], [ 40.435067, -3.644062 ], [ 40.435013, -3.644173 ], [ 40.434957, -3.644287 ], [ 40.434717, -3.64478 ], [ 40.434643, -3.644924 ], [ 40.434579, -3.645068 ], [ 40.434415, -3.645421 ], [ 40.434336, -3.645575 ], [ 40.434039, -3.64619 ], [ 40.434015, -3.646246 ], [ 40.433969, -3.646342 ], [ 40.433937, -3.646408 ], [ 40.433772, -3.646738 ], [ 40.433627, -3.647029 ], [ 40.433595, -3.647098 ], [ 40.433539, -3.64721 ], [ 40.433494, -3.647304 ], [ 40.433262, -3.647805 ] ], line: "113", destination: "Méndez Álvaro", color: "#0178BC" }, 
          { id: 13360, source: 20, target: 23, distance: 1.37, duration: 13, transportMode: "Bus", steps: [], "polyline": [ [ 40.433262, -3.647805 ], [ 40.433206, -3.647926 ], [ 40.433145, -3.648102 ], [ 40.433117, -3.648239 ], [ 40.433102, -3.648351 ], [ 40.433064, -3.648579 ], [ 40.433051, -3.648664 ], [ 40.433029, -3.648818 ], [ 40.432986, -3.649116 ], [ 40.432977, -3.649178 ], [ 40.432939, -3.649443 ], [ 40.432817, -3.650306 ], [ 40.432811, -3.650352 ], [ 40.432798, -3.650439 ], [ 40.432759, -3.650706 ], [ 40.432635, -3.651561 ], [ 40.432621, -3.651664 ], [ 40.432605, -3.651779 ], [ 40.432551, -3.652158 ], [ 40.432538, -3.652249 ], [ 40.432515, -3.652398 ], [ 40.432506, -3.652466 ], [ 40.432454, -3.652861 ], [ 40.432426, -3.653082 ], [ 40.432397, -3.653277 ], [ 40.432381, -3.653392 ], [ 40.432277, -3.654148 ], [ 40.432264, -3.654247 ], [ 40.432206, -3.654686 ], [ 40.432163, -3.655009 ], [ 40.432132, -3.655247 ], [ 40.432115, -3.655375 ], [ 40.432077, -3.655656 ], [ 40.432067, -3.655726 ], [ 40.432049, -3.655885 ], [ 40.43203, -3.656019 ], [ 40.431932, -3.656759 ], [ 40.431911, -3.656926 ], [ 40.432044, -3.656937 ], [ 40.432104, -3.656952 ], [ 40.432044, -3.656937 ], [ 40.431911, -3.656926 ], [ 40.431905, -3.656963 ], [ 40.431839, -3.657464 ], [ 40.431819, -3.657624 ], [ 40.431799, -3.657762 ], [ 40.431728, -3.658315 ], [ 40.431697, -3.658668 ], [ 40.431604, -3.659485 ], [ 40.431578, -3.659703 ], [ 40.431539, -3.660023 ], [ 40.431534, -3.660089 ], [ 40.431503, -3.660345 ], [ 40.431494, -3.6604 ], [ 40.431425, -3.660903 ], [ 40.431414, -3.660989 ], [ 40.431402, -3.661076 ], [ 40.431371, -3.661298 ], [ 40.431313, -3.661708 ], [ 40.431307, -3.661745 ], [ 40.431265, -3.662028 ], [ 40.431243, -3.662223 ], [ 40.43121, -3.662421 ], [ 40.431165, -3.662544 ], [ 40.430929, -3.663025 ] ], line: "38", destination: "Manuel Becerra", color: "#0178BC" }, 
          { id: 13361, source: 23, target: 24, distance: 0.78, duration: 9, transportMode: "A pie", steps: [ "0-4:Camina hacia el suroeste en Calle de Alcalá", "4-13:¡Gire a la derecha!", "13-16:¡Gire a la derecha a Calle de Alcalá!", "16-17:¡Gire bastante a la derecha a Calle del Cardenal Belluga!", "17-20:¡Gire a la izquierda a Calle de Ruiz Perelló!", "20-21:¡Gire a la izquierda a Calle del Doctor Gómez Ulla!", "21-22:¡Gire a la derecha a Calle del Doctor Gómez Ulla!", "22-23:¡Gire a la derecha a Plaza de Manuel Becerra!", "23-27:¡Gire a la izquierda a Plaza de Manuel Becerra!", "27-30:¡Gire ligeramente a la izquierda a Plaza de Manuel Becerra!", "30-31:¡Gire a la derecha a Calle de Alcalá!", "31-31:Llegar a Calle de Alcalá, es recto" ], "polyline": [ [ 40.430929, -3.663025 ], [ 40.430899, -3.663087 ], [ 40.430713, -3.663329 ], [ 40.430705, -3.663345 ], [ 40.43067, -3.663426 ], [ 40.430808, -3.663534 ], [ 40.430667, -3.663815 ], [ 40.430651, -3.663847 ], [ 40.430627, -3.663893 ], [ 40.430562, -3.664018 ], [ 40.43049, -3.664172 ], [ 40.430447, -3.664174 ], [ 40.430308, -3.664452 ], [ 40.430207, -3.664366 ], [ 40.430162, -3.66446 ], [ 40.429986, -3.664826 ], [ 40.429908, -3.664988 ], [ 40.430269, -3.665154 ], [ 40.429897, -3.666879 ], [ 40.429799, -3.667367 ], [ 40.429922, -3.667761 ], [ 40.428704, -3.668399 ], [ 40.428452, -3.668641 ], [ 40.428441, -3.668761 ], [ 40.4284, -3.668892 ], [ 40.428355, -3.668996 ], [ 40.428285, -3.669098 ], [ 40.428206, -3.66918 ], [ 40.428091, -3.66922 ], [ 40.428026, -3.669211 ], [ 40.427928, -3.669179 ], [ 40.427905, -3.669207 ] ], line: null, destination: null, color: "#2D2E2D" }, 
          { id: 13362, source: 24, target: 25, distance: 0.63, duration: 7, transportMode: "Metro", steps: [], "polyline": [ [ 40.427803637790497, -3.66926468417177 ], [ 40.427693748068002, -3.66946388794924 ], [ 40.427584484955702, -3.66966357120664 ], [ 40.427366847464498, -3.6700852207662 ], [ 40.4273668474645, -3.6700852207662 ], [ 40.4269941682142, -3.67080724036154 ], [ 40.4267572290022, -3.67127360921626 ], [ 40.426394236983, -3.67202259029178 ], [ 40.4263133605322, -3.67218880439575 ], [ 40.4258014080655, -3.67324246675437 ], [ 40.4256407085261, -3.67357483440038 ], [ 40.4255571407379, -3.67375448159136 ], [ 40.4254599298662, -3.67397159980223 ], [ 40.4251461742326, -3.6746939317905 ], [ 40.4250911937708, -3.67482175835288 ], [ 40.4249965991056, -3.6750380733178 ], [ 40.424943806674, -3.67516156066688 ], [ 40.4247735946887, -3.67555323538707 ], [ 40.4245385016728, -3.67608607575084 ], [ 40.4243890881779, -3.67641851283005 ] ], line: "2", destination: "Cuatro Caminos", color: "#ED1C24" }, 
          { id: 13363, source: 25, target: 29, distance: 1.72, duration: 11, transportMode: "Metro", steps: [], "polyline": [ [ 40.4247705889091, -3.67683776132107 ], [ 40.4247736330945, -3.67687376403964 ], [ 40.4247761334257, -3.67690833020144 ], [ 40.4247786339709, -3.67694301189392 ], [ 40.4247812252811, -3.67697757661524 ], [ 40.4247838149691, -3.67701226274312 ], [ 40.4247864956533, -3.67704694624952 ], [ 40.4247891761165, -3.67708151187271 ], [ 40.4247918567661, -3.67711619774187 ], [ 40.4247946266033, -3.67715088215048 ], [ 40.4248001676067, -3.67722001875852 ], [ 40.4248030290891, -3.67725458621102 ], [ 40.4248057246755, -3.67728655973912 ], [ 40.4248111181039, -3.67735027105804 ], [ 40.4248137242624, -3.67738212699166 ], [ 40.4248164207143, -3.67741410053848 ], [ 40.4248189367978, -3.67744595085794 ], [ 40.4248241508618, -3.67750966158087 ], [ 40.4248267544907, -3.67754163420617 ], [ 40.4248292705183, -3.67757348807108 ], [ 40.4248318782138, -3.67760522497447 ], [ 40.4248347838551, -3.67764745534805 ], [ 40.4248375106177, -3.67768992205515 ], [ 40.4248398739158, -3.67773214699224 ], [ 40.4248418797706, -3.6777744862281 ], [ 40.4248436128479, -3.67781694296964 ], [ 40.4248450756683, -3.67785939464253 ], [ 40.4248461788101, -3.67790172718006 ], [ 40.4248470112203, -3.67794428923177 ], [ 40.4248475756153, -3.67798661754111 ], [ 40.4248477764979, -3.67802917325317 ], [ 40.4248476176951, -3.67807161100611 ], [ 40.4248473676183, -3.67811440149356 ], [ 40.424847025869, -3.67815730540721 ], [ 40.4248462732258, -3.67828591025165 ], [ 40.4248461115831, -3.67832881597283 ], [ 40.4248459514962, -3.67837160736209 ], [ 40.4248457898009, -3.67841451661873 ], [ 40.4248456288022, -3.67845730446177 ], [ 40.4248454882116, -3.67854312363185 ], [ 40.4248458662781, -3.67858615501697 ], [ 40.4248465161696, -3.67862907242947 ], [ 40.4248474345194, -3.67867198900452 ], [ 40.4248484438253, -3.67871490885261 ], [ 40.4248497249564, -3.67875771472942 ], [ 40.4248510945846, -3.67880063584474 ], [ 40.4248527369319, -3.67884344417741 ], [ 40.4248545569328, -3.67888637336091 ], [ 40.4248566487728, -3.67892918621731 ], [ 40.4248588322821, -3.67897188093541 ], [ 40.4248612831058, -3.67901446281823 ], [ 40.424884557722, -3.67948540359373 ], [ 40.4249130895452, -3.68007357541104 ], [ 40.4249135660478, -3.68008430882486 ], [ 40.4249145231601, -3.68010553638996 ], [ 40.4249150904382, -3.68011615283462 ], [ 40.4249155703467, -3.68012676604176 ], [ 40.4249161376297, -3.68013738130797 ], [ 40.4249166148337, -3.68014799448818 ], [ 40.4249171848104, -3.68015861096071 ], [ 40.4249176619985, -3.68016922649872 ], [ 40.4249182303997, -3.68017995730312 ], [ 40.4249187983645, -3.68019045587197 ], [ 40.4249473157773, -3.68078015943931 ], [ 40.4249754929559, -3.68136609012933 ], [ 40.424991137621, -3.68160107064737 ], [ 40.4249934116615, -3.68162809022714 ], [ 40.4249957753759, -3.68165487376706 ], [ 40.4250006870557, -3.68170820576572 ], [ 40.4250031426452, -3.68173498906003 ], [ 40.4250057797817, -3.68176153960004 ], [ 40.425008414607, -3.68178832824458 ], [ 40.4250111418163, -3.68181487969821 ], [ 40.4250138674304, -3.6818415478431 ], [ 40.4250196803565, -3.6818946543815 ], [ 40.425024117264, -3.68193666474796 ], [ 40.4250263359209, -3.68195778722997 ], [ 40.4250286453335, -3.68197879628241 ], [ 40.4250308635649, -3.68199968417352 ], [ 40.4250330828988, -3.68202068996125 ], [ 40.4250352997387, -3.68204181243042 ], [ 40.4250442660062, -3.68212571743589 ], [ 40.4250516721714, -3.68219888042288 ], [ 40.42506280925, -3.68232724973297 ], [ 40.4250722833828, -3.6824624419172 ], [ 40.4250773379118, -3.68255255416462 ], [ 40.4250780468208, -3.68256920422014 ], [ 40.4250780468208, -3.68256920422014 ], [ 40.4250831137173, -3.68268817937427 ], [ 40.4250867284365, -3.68282389945768 ], [ 40.4250869562081, -3.68284665341185 ], [ 40.4250874044415, -3.68289263396231 ], [ 40.4250875396166, -3.68291550486457 ], [ 40.4250875840058, -3.68293849273287 ], [ 40.4250876304037, -3.68296159732686 ], [ 40.4250876747908, -3.68298458401632 ], [ 40.4250876297638, -3.68300745545366 ], [ 40.4250872232609, -3.68307641242033 ], [ 40.425086827885, -3.68311283345947 ], [ 40.4250867921269, -3.68314937837843 ], [ 40.4250865777988, -3.68318580124866 ], [ 40.4250864526363, -3.68322222619967 ], [ 40.4250864175403, -3.68325865324074 ], [ 40.4250862939594, -3.6832949591444 ], [ 40.4250862581578, -3.68333150170463 ], [ 40.4250864248097, -3.68344078204267 ], [ 40.4250865698079, -3.68347721208513 ], [ 40.4250871239115, -3.68352048119487 ], [ 40.4250877714974, -3.68356363100972 ], [ 40.4250886877102, -3.68360690378686 ], [ 40.4250896046039, -3.6836500586878 ], [ 40.4250907915326, -3.68369309843989 ], [ 40.4250920678331, -3.6837362569826 ], [ 40.4250934357935, -3.68377929974975 ], [ 40.4250949823167, -3.68382246103233 ], [ 40.4250966180079, -3.68386562321992 ], [ 40.4250984372666, -3.68390866702692 ], [ 40.4251004339628, -3.6839517149912 ], [ 40.4251237886847, -3.68442124761879 ], [ 40.4251542857017, -3.68500755729823 ], [ 40.4251553037786, -3.68502442508316 ], [ 40.4251684788062, -3.68524299488162 ], [ 40.4251715567226, -3.68528593601718 ], [ 40.4251748181873, -3.68532876231406 ], [ 40.4251780785541, -3.68537146718299 ], [ 40.4251814291711, -3.68541429439301 ], [ 40.4251850489312, -3.68545700527625 ], [ 40.4251885810982, -3.68549959621153 ], [ 40.4251921134443, -3.68554230621625 ], [ 40.425195821635, -3.68558513707405 ], [ 40.4251996240164, -3.68562772958761 ], [ 40.4252034256619, -3.68567044351937 ], [ 40.4252074088808, -3.6857129199945 ], [ 40.4252105294748, -3.68574878854471 ], [ 40.4252169530985, -3.68582029173913 ], [ 40.4252200743584, -3.6858560424216 ], [ 40.4252232874938, -3.6858917940406 ], [ 40.4252295290573, -3.68596329541223 ], [ 40.4252325612902, -3.68599916308776 ], [ 40.4252356824946, -3.68603491378598 ], [ 40.425241834584, -3.68610629639002 ], [ 40.4252444271388, -3.68614003769008 ], [ 40.4252471106834, -3.68617377755968 ], [ 40.425249614734, -3.68620740008098 ], [ 40.4252520263897, -3.68624125743466 ], [ 40.4252543502508, -3.68627487812942 ], [ 40.4252565815158, -3.68630861576979 ], [ 40.4252586337029, -3.68634246947655 ], [ 40.4252606874808, -3.686376205317 ], [ 40.4252625583695, -3.6864099404791 ], [ 40.4252660321011, -3.68647763795842 ], [ 40.4252718588233, -3.68658874440516 ], [ 40.4252844823912, -3.68683124925615 ], [ 40.4252844823912, -3.68683124925615 ], [ 40.4252996002158, -3.68712162773871 ], [ 40.4253007728346, -3.68715170023378 ], [ 40.425302214306, -3.68718201005632 ], [ 40.4253036564631, -3.68721220318139 ], [ 40.4253071724489, -3.68727271374937 ], [ 40.4253091541908, -3.68730291237094 ], [ 40.4253112278183, -3.68733311075077 ], [ 40.4253133911089, -3.6873630766337 ], [ 40.4253157342745, -3.68739339564578 ], [ 40.4253208728952, -3.68745356910036 ], [ 40.4253232566926, -3.68747705122602 ], [ 40.4253258186534, -3.68750041728279 ], [ 40.4253285625669, -3.68752378755169 ], [ 40.4253379691086, -3.68759343525808 ], [ 40.4253414361992, -3.68761669265718 ], [ 40.4253451722323, -3.68763971820717 ], [ 40.4253489985525, -3.68766286138499 ], [ 40.4253573748413, -3.68770880500143 ], [ 40.4253683264286, -3.68776101921164 ], [ 40.4253798210791, -3.68781265426261 ], [ 40.4253915877838, -3.68786428856608 ], [ 40.4254039837596, -3.68791569352912 ], [ 40.4254166529722, -3.68796674764069 ], [ 40.4254298653669, -3.68801780848504 ], [ 40.425443435878, -3.68806863722908 ], [ 40.4254575491799, -3.68811923575552 ], [ 40.425471936834, -3.68816959897185 ], [ 40.4254868627542, -3.68821973546276 ], [ 40.4255021543164, -3.68826928392071 ], [ 40.4255186468738, -3.68832910299107 ], [ 40.4255417086753, -3.68842010834044 ], [ 40.4255558508419, -3.68848096212393 ], [ 40.42556918049, -3.68854239943002 ], [ 40.4255814257032, -3.68860394004928 ], [ 40.4255861298908, -3.68863122064974 ], [ 40.4255948090699, -3.68868659608341 ], [ 40.4256021362471, -3.68874207562528 ], [ 40.4256083827624, -3.68879778228287 ], [ 40.4256134565654, -3.68885359133509 ], [ 40.4256173551169, -3.6889096265325 ], [ 40.4256189401648, -3.68894630379367 ], [ 40.4256209331992, -3.68901988443757 ], [ 40.425621486836, -3.6890935671019 ], [ 40.4256204181748, -3.68916735463054 ], [ 40.4256178160382, -3.68924100626037 ], [ 40.4256137773083, -3.68931428956298 ], [ 40.4256068731129, -3.68939944881475 ], [ 40.4256026577344, -3.68944160745312 ], [ 40.4255924256161, -3.6895261444461 ], [ 40.4255865900705, -3.68956805075103 ], [ 40.4255800336262, -3.68960983297974 ], [ 40.4255730301344, -3.68965149510685 ], [ 40.4255573093321, -3.68973456016389 ], [ 40.4255486860113, -3.68977561157586 ], [ 40.425539164114, -3.68981642156375 ], [ 40.4255298204665, -3.6898577037222 ], [ 40.4255205639891, -3.68989886887493 ], [ 40.425511399581, -3.68994015284202 ], [ 40.4255023259467, -3.68998131984056 ], [ 40.4254935202443, -3.69002272533584 ], [ 40.4254848039084, -3.69006424961848 ], [ 40.4254761790498, -3.6901055390556 ], [ 40.4254676446557, -3.69014706517647 ], [ 40.4254510214403, -3.69023047441697 ], [ 40.425437274144, -3.69031473939098 ], [ 40.425425869583, -3.69039938193903 ], [ 40.425416713364, -3.6904845189892 ], [ 40.425409894684, -3.69057014910433 ], [ 40.4254055111091, -3.69065592553119 ], [ 40.425403378508, -3.69074160473167 ], [ 40.4254032122258, -3.69078451306932 ], [ 40.4254035864295, -3.6908274281154 ], [ 40.425404681303, -3.69087034935685 ], [ 40.425406317388, -3.69091315589518 ], [ 40.4254087651002, -3.69095597427757 ], [ 40.4254116630314, -3.69099867820688 ], [ 40.4254151924555, -3.69104138624507 ], [ 40.4254194430296, -3.69108386943572 ], [ 40.4254243259975, -3.69112635674695 ], [ 40.4254298391372, -3.6911686171031 ], [ 40.4254329546415, -3.69118998495928 ], [ 40.4254436598291, -3.69125316172852 ], [ 40.4254476775544, -3.69127430659672 ], [ 40.4254516956028, -3.69129509545864 ], [ 40.4254604586797, -3.69133667945441 ], [ 40.4254651975913, -3.69135759358976 ], [ 40.4254750417877, -3.69139871595408 ], [ 40.4254916122364, -3.69146030365037 ], [ 40.4255098089184, -3.69152096495277 ], [ 40.4255295412407, -3.69158093470694 ], [ 40.4255508104264, -3.69163985809515 ], [ 40.4255736182786, -3.69169773513891 ], [ 40.4255856982205, -3.69172638942494 ], [ 40.4255981417208, -3.69175480931811 ], [ 40.4256106760253, -3.69178310873046 ], [ 40.4256233902758, -3.69181129564848 ], [ 40.4256489118507, -3.6918673179935 ], [ 40.4256619878304, -3.69189527287973 ], [ 40.4256749751436, -3.69192298874009 ], [ 40.4256882319776, -3.69195082879494 ], [ 40.425701581397, -3.69197855192436 ], [ 40.4257150203297, -3.69200591878982 ], [ 40.4257285513163, -3.69203340803151 ], [ 40.4257377183821, -3.69205200762146 ], [ 40.4258303004032, -3.69223803436214 ], [ 40.4259445580092, -3.69246840732275 ], [ 40.4259445580092, -3.69246840732275 ], [ 40.4260741185868, -3.69272963790286 ], [ 40.4261909107307, -3.69296475634307 ], [ 40.4262860725166, -3.69315631618037 ], [ 40.4263661025799, -3.69331675241622 ], [ 40.4266102605512, -3.69381131324726 ], [ 40.4268108876032, -3.69420263476775 ], [ 40.4270150544988, -3.69459010238814 ], [ 40.4272698935457, -3.69507476325429 ], [ 40.4273198421481, -3.69517382952113 ], [ 40.4273377363215, -3.695209263481 ], [ 40.4273552680467, -3.69524504267622 ], [ 40.4273725330886, -3.69528082268039 ], [ 40.4273893405545, -3.69531718625254 ], [ 40.4274059696198, -3.6953535515421 ], [ 40.4274221443423, -3.69539026229809 ], [ 40.4274380502608, -3.69542732632549 ], [ 40.4274535933389, -3.69546450098451 ], [ 40.4274687712218, -3.69550202792137 ], [ 40.4274835916477, -3.695539669081 ], [ 40.4274980492115, -3.69557742440716 ], [ 40.4275097432317, -3.69561031549548 ], [ 40.4275213478386, -3.69564309250108 ], [ 40.4275328609612, -3.6956760996366 ], [ 40.4275443760603, -3.69570922587107 ], [ 40.4275555270019, -3.69574223283354 ], [ 40.4275667684228, -3.69577547297963 ], [ 40.4275778305443, -3.69580871482562 ], [ 40.4275887126779, -3.69584207271598 ], [ 40.4275994110504, -3.69587542518644 ], [ 40.4276101115831, -3.6959090158246 ], [ 40.4276207193117, -3.69594260669566 ], [ 40.4276363739221, -3.69599145605279 ], [ 40.4276678587668, -3.69608915310892 ], [ 40.4276877811753, -3.69615082213552 ] ], line: "4", destination: "Argüelles", color: "#B65518" }, 
          { id: 13364, source: 29, target: 30, distance: 0.6, duration: 8, transportMode: "Metro", steps: [], "polyline": [ [ 40.4286231274272, -3.69625042169322 ], [ 40.4285029698016, -3.69637856458105 ], [ 40.4281232241685, -3.69678537924258 ], [ 40.4281166931213, -3.69679262098395 ], [ 40.4281072598651, -3.69680336709586 ], [ 40.4280979148697, -3.69681411765241 ], [ 40.4280732028038, -3.69684286574171 ], [ 40.4280304161871, -3.69689264260489 ], [ 40.4279642610303, -3.69697200885254 ], [ 40.4279395796256, -3.69700134305317 ], [ 40.4279030964152, -3.69704576425787 ], [ 40.4278790397012, -3.69707593125697 ], [ 40.4278551649504, -3.69710610011347 ], [ 40.4278314675036, -3.69713674469302 ], [ 40.4277743306216, -3.69721454961881 ], [ 40.4277197045268, -3.69729474047703 ], [ 40.4276876017373, -3.69734463068146 ], [ 40.4276462006047, -3.69741245939259 ], [ 40.4276063236108, -3.69748195538446 ], [ 40.4275683315801, -3.69755229480962 ], [ 40.427540710856, -3.69760588681084 ], [ 40.4275055881257, -3.69767861469414 ], [ 40.4274718052295, -3.69775324374022 ], [ 40.4274473167635, -3.69781028317885 ], [ 40.4274084471084, -3.69790643187603 ], [ 40.4273757606419, -3.69799356582044 ], [ 40.4273493751698, -3.69806650154885 ], [ 40.4273156346154, -3.69816376516813 ], [ 40.4272650284881, -3.69830930385226 ], [ 40.4272312006835, -3.69840621266229 ], [ 40.427197279299, -3.6985032382948 ], [ 40.427163362883, -3.69860002456899 ], [ 40.4263946610746, -3.70079937503754 ], [ 40.4263198352637, -3.70101610094479 ], [ 40.426302799712, -3.70106236889841 ], [ 40.4262771240306, -3.70113649085701 ], [ 40.4262454207099, -3.70122422023798 ], [ 40.426177247066, -3.70139880874555 ], [ 40.4261395116107, -3.70150070757559 ], [ 40.4261374975262, -3.70150614594887 ], [ 40.4261077831133, -3.70159283702589 ], [ 40.4259959367462, -3.70191196795995 ], [ 40.4258904833128, -3.70221535941196 ] ], line: "10a", destination: "Puerta del Sur", color: "#005AA9" }, 
          { id: 13365, source: 30, target: 31, distance: 0.71, duration: 9, transportMode: "Metro", steps: [], "polyline": [ [ 40.4259923177535, -3.70111603088109 ], [ 40.4258464295361, -3.70105728379409 ], [ 40.4254440695494, -3.7008958561494 ], [ 40.4254293315878, -3.7008899268119 ], [ 40.4254145035412, -3.70088399654194 ], [ 40.4252516274366, -3.70082277658732 ], [ 40.425146167504, -3.700787144273 ], [ 40.4250840283464, -3.70076846190166 ], [ 40.4249540565959, -3.70073387446595 ], [ 40.4248547331878, -3.70071138769131 ], [ 40.4247549344719, -3.70069255515801 ], [ 40.4246404439611, -3.70067533494221 ], [ 40.4245261940221, -3.70066271708443 ], [ 40.4244262443444, -3.7006543723825 ], [ 40.4242408060907, -3.70064455242068 ], [ 40.4238684259044, -3.70063562434131 ], [ 40.4236867099249, -3.70063610121991 ], [ 40.423491172246, -3.700642678866 ], [ 40.4232518377559, -3.70066625078342 ], [ 40.4229993775659, -3.70070029794902 ], [ 40.422747591811, -3.70074212724003 ], [ 40.4224688821834, -3.70079664711381 ], [ 40.4221473405446, -3.70087217364049 ], [ 40.421921201337, -3.70093336669449 ], [ 40.4217182151295, -3.70099503544539 ], [ 40.4216378731258, -3.70102153621113 ], [ 40.4215945430573, -3.70103583412861 ], [ 40.4214304998219, -3.70109354511286 ], [ 40.4213216021226, -3.70113426226664 ], [ 40.4208605084847, -3.70131419381572 ], [ 40.4206543436779, -3.70139456983199 ], [ 40.4204390611483, -3.70147814883013 ], [ 40.4202363303609, -3.70155690809799 ], [ 40.4197247047121, -3.70176051920591 ] ], line: "1", destination: "Valdecarros", color: "#2DBEF0" }, { id: 13366, source: 31, target: 32, distance: 0.44, duration: 5, transportMode: "A pie", steps: [ "0-2:Camina hacia el oeste", "2-3:¡Gire a la derecha!", "3-8:¡Gire a la izquierda!", "8-9:¡Gire a la derecha!", "9-13:¡Gire a la derecha a Calle de la Montera!", "13-14:¡Gire a la izquierda a Pasaje del Comercio!", "14-19:¡Gire a la derecha a Calle de la Montera!", "19-20:¡Siga todo recto!", "20-24:¡Gire a la derecha!", "24-25:¡Gire bastante a la izquierda a Plaza de la Puerta del Sol!", "25-25:Llegar a Plaza de la Puerta del Sol, a la izquierda" ], "polyline": [ [ 40.419982, -3.701806 ], [ 40.420011, -3.701931 ], [ 40.419999, -3.701955 ], [ 40.420004, -3.70198 ], [ 40.419934, -3.701989 ], [ 40.41993, -3.70194 ], [ 40.419924, -3.701861 ], [ 40.419925, -3.701846 ], [ 40.419955, -3.701842 ], [ 40.41995, -3.701824 ], [ 40.419878, -3.701833 ], [ 40.419844, -3.7018 ], [ 40.418947, -3.702227 ], [ 40.418907, -3.702246 ], [ 40.418863, -3.702144 ], [ 40.418797, -3.70218 ], [ 40.418445, -3.702377 ], [ 40.418233, -3.702495 ], [ 40.418063, -3.702589 ], [ 40.41721, -3.703063 ], [ 40.417072, -3.703132 ], [ 40.417087, -3.703226 ], [ 40.417091, -3.703313 ], [ 40.417094, -3.703389 ], [ 40.417087, -3.703521 ], [ 40.416929, -3.703413 ] ], line: null, destination: null, color: "#2D2E2D" } 
        ] 
      };

      //this.sharedService.showToast('No se ha podido obtener la ruta', 3000);
      //this.router.navigate(['/']);
    }

    // Iterate over the segments of the route
    this.route.segments.forEach((segment, index) => {
      // Transform some lines to unify zones in one line
      if (linesZone.has(segment.line)) {
        segment.line = linesZone.get(segment.line);
      }

      // Insert the steps if applicable
      if (segment.steps && segment.steps.length) {
        // Init list for the steps
        let steps = [];
        segment.steps.forEach((step: string) => {
          // Split way-points & instruction
          let parts = step.split(':', 2);
          // Get the source/target point & the instruction
          let wayPoints = parts[0].split('-', 2);
          let first = wayPoints[0];
          let last = wayPoints[1];
          let instruction = parts[1];
          steps.push({ first: first, last: last, instruction: instruction });
        });
        this.segmentsSteps.set(index, steps);
      }

      // Dash pattern for the segment (for walk segments)
      let dashedSegment = segment.transportMode === 'A pie';
      // Icon (mode of transport) for the segment
      let iconSegment = iconTransport.get(segment.transportMode);
      // Type of transport (has instructions walk/bike or intermediate stations)
      let stepSegment = segment.transportMode === 'A pie' || segment.transportMode === 'BiciMAD';

      // Store some features of the segments
      this.segmentsVisual.push({ dashed: dashedSegment, icon: iconSegment, steps: stepSegment });
    });
  }

  ionViewDidEnter() {
    this.isOpen = true;

    // OpenStreetMap
    // https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png
    const standard = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' + 
      '&copy; <a href="https://carto.com/attributions#basemaps">CARTO</a>'
    });

    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; <a href="https://www.esri.com/en-us/home"> Esri</a>'
    });

    const layers = {
      "<span style='cursor: pointer'>Satélite</span>": satellite,
      "<span style='cursor: pointer'>Predeterminado</span>": standard
    };

    this.map = L.map('map', {
      zoomControl: false,
      center: [40.416694, -3.703250],
      zoom: 12,
      layers: [standard, satellite]
    });

    L.control.zoom({ position: 'topright' }).addTo(this.map);
    L.control.layers(layers, null, { position: 'topright' }).addTo(this.map);


    let multiPolyline: L.Polyline<LineString | MultiLineString, any>;
    let coordinates = [];
    // Iterate over the segments of the route
    this.route.segments.forEach((segment, index) => {
      // Transform number[][] to LatLng array in polyline
      let coords = segment.polyline.map(coord => new L.LatLng(coord[0], coord[1]));

      // Establish the color for the segment
      let color = segment.color;
      // Dash pattern for the segment (for walk segments)
      let dashArray = this.segmentsVisual[index].dashed ? '1 7' : null;
      // Image to be used as icon
      let iconSegment = this.segmentsVisual[index].icon;

      // Tooltip set line if applicable
      let lineTooltip = segment.line ?
        '<ion-badge mode="md" style="margin-left: 3px; background-color: '
        + color
        + '; color: #ffffff;">'
        + segment.line
        + '</ion-badge>' : '';
      // Tooltip for the polylines that make up the route
      let tooltip =
        '<div style="text-align: center">'
        + '<div style="display: block"><img style="height: 20px; width: 20px; margin: 0px auto;" src="./assets/'
        + iconSegment + '">'
        + lineTooltip
        + '</div>'
        + this.route.points[segment.source].name
        + '<ion-icon style="vertical-align: middle; font-size: 9px; opacity: 0.7" name="chevron-forward-outline"></ion-icon>'
        + this.route.points[segment.target].name
        + '</div>';

      // Add polyline to map
      L.polyline(coords, {
        stroke: true,
        color: color,
        weight: 5,
        lineJoin: 'round',
        lineCap: 'round',
        dashArray: dashArray
      }).bindTooltip(tooltip, {
        sticky: true
      }).addTo(this.map);

      // Add the coordinates of each segment
      coordinates.push.apply(coordinates, coords);

      // Icon for marker
      let icon = L.icon({
        iconUrl: './assets/' + iconSegment,
        iconSize: [20, 20]
      });

      // Add markers to map
      new L.Marker([this.route.points[segment.source].latitude, this.route.points[segment.source].longitude], {
        icon: icon
      }).addTo(this.map).bindTooltip(this.route.points[segment.source].name);

      // Walk polyline for stops with transfer between lines
      if (index > 0 && segment.transportMode === this.route.segments[index - 1].transportMode) {
        let previous = this.route.segments[index - 1].polyline[this.route.segments[index - 1].polyline.length - 1];
        let current = segment.polyline[0];
        coords = [new L.LatLng(previous[0], previous[1]), new L.LatLng(current[0], current[1])];
        // Add polyline to map
        L.polyline(coords, {
          stroke: true,
          color: '#2D2E2D',
          weight: 5,
          lineJoin: 'round',
          lineCap: 'round',
          dashArray: '1 7'
        }).addTo(this.map);

        // Add the coordinates of each segment
        coordinates.push.apply(coordinates, coords);
      }
    });

    // Marker for destination point
    new L.Marker([this.route.destination.latitude, this.route.destination.longitude], {
      icon: L.icon({ iconUrl: './assets/destination.png', iconSize: [25, 25] })
    }).addTo(this.map).bindTooltip(this.route.destination.name);

    // Polyline of the whole route
    multiPolyline = L.polyline(coordinates);
    this.map.fitBounds(multiPolyline.getBounds(), { paddingTopLeft: [this.showSideMenu ? 300 : 0, 0] });

    // Remove highlighted polyline if 
    this.map.on('zoomend', () => this.closeStep());
  }

  // Close/open sidemenu
  toggleMenu() {
    this.isOpen = !this.isOpen;
  }

  // When step in walk or bike is selected
  zoomToStep(first: number, last: number, index: number) {
    // If there is already a polyline highlighted remove it from the map
    if (this.stepSelected) {
      this.map.removeLayer(this.stepSelected);
    }

    // Get coordinates to highlight & zoom
    let polyline = this.route.segments[index].polyline.slice(first, ++last)
      .map(coord => new L.LatLng(coord[0], coord[1]));;

    // Add polyline to map
    this.stepSelected = L.polyline(polyline, {
      stroke: true,
      color: '#2D2E2D',
      weight: 5,
      lineJoin: 'round',
      lineCap: 'round'
    }).addTo(this.map);
    // Zoom to polyline
    this.map.fitBounds(this.stepSelected.getBounds(), { paddingTopLeft: [this.showSideMenu ? 150 : 0, 0] });
  }

  // Remove polyline highlighted from map
  closeStep() {
    // Already polyline & zoom has to be lower than 16
    if (this.stepSelected && this.map.getZoom() <= 15) {
      this.map.removeLayer(this.stepSelected);
      this.stepSelected = undefined;
    }
  }

  // Check if there are intermediate stops in a segment route
  checkIntermediateStops(segment: any) {
    return (segment.target - segment.source) > 1;
  }

  // Return names of the intermediate stops 
  intermediateStopsNames(start: number, end: number) {
    let names = [];
    for (let i = start + 1; i < end; i++) {
      names.push(this.route.points[i].name);
    }
    return names;
  }

}
